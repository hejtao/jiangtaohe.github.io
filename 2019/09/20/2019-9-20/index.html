<!DOCTYPE html>
<html lang="z">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>MySQL是怎样运行的：从根儿上理解 MySQL | 米琴香光</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="RSS">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="MySQL是怎样运行的：从根儿上理解 MySQL | 米琴香光">
    <meta name="twitter:description" content="RSS">

    <meta property="og:type" content="article">
    <meta property="og:title" content="MySQL是怎样运行的：从根儿上理解 MySQL | 米琴香光">
    <meta property="og:description" content="RSS">

    
    <meta name="author" content="Jiang-Tao He">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/icon.jpg">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="米琴香光" href="/atom.xml">
    

    <link rel="canonical" href="https://hejtao.netlify.com/2019/09/20/2019-9-20/"/>

              
<link rel="stylesheet" href="/css/prism.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body class="home-template no-js">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>
    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/"><img src="/images/avatar.jpg" width="80" alt="米琴香光 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="返回封面">米琴香光</a></h1>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description"></p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" class="blog-button">笔记</a></li>
            
              <li class="navigation__item"><a href="/archives">归档</a></li>
            
              <li class="navigation__item"><a href="/videos">视频</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="https://weibo.com/hjt1993" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li>


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/hejtao" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  <li class="navigation__item">
    <a href="https://facebook.com/chiangtaoho" title="上Facebook找我" target="_blank">
      <i class='social fa fa-facebook'></i>
      <span class="label">Facebook</span>
    </a>
  </li>


<!-- Twitter -->



  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  <li class="navigation__item">
    <a href="mailto:hejtao@outlook.com" title="邮件联系我" target="_blank">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>


  </ul>
</nav>

          </div>
          <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=250 height=86 src="//music.163.com/outchain/player?type=2&id=27538415&auto=0&height=66"></iframe>
        </div>
    </div>
    </div>
    <div class="panel-cover--overlay cover-blue"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2019-09-19T16:00:00.000Z" class="post-list__meta--date date">2019-09-20</time> &#8226; <span class="post-meta__tags tags"> 
  <a class="tag-link" href="/tags/MySQL/">MySQL</a>, <a class="tag-link" href="/tags/长文/">长文</a>
 </span>
    

    </div>
    <h1 class="post-title">MySQL是怎样运行的：从根儿上理解 MySQL</h1>
  </header>

  <section class="post">
    <meta name="referrer" content="no-referrer">
<div class="toc">
<!-- toc -->
<ul>
<li><a href="#chong-xin-ren-shi-mysql">重新认识MySQL</a>
<ul>
<li><a href="#ke-hu-duan-fu-wu-qi">客户端 + 服务器</a></li>
<li><a href="#qi-dong-fu-wu-qi-cheng-xu">启动服务器程序</a>
<ul>
<li><a href="#unix">UNIX</a></li>
<li><a href="#windows">Windows</a></li>
</ul>
</li>
<li><a href="#qi-dong-ke-hu-duan-cheng-xu">启动客户端程序</a></li>
<li><a href="#ke-hu-duan-yu-fu-wu-qi-de-tong-xin">客户端与服务器的通信</a>
<ul>
<li><a href="#tcp-ip">TCP/IP</a></li>
<li><a href="#ming-ming-guan-dao-he-gong-xiang-nei-cun">命名管道和共享内存</a></li>
<li><a href="#unix-yu-tao-jie-zi-wen-jian">UNIX域套接字文件</a></li>
</ul>
</li>
<li><a href="#fu-wu-qi-chu-li-ke-hu-duan-qing-qiu">服务器处理客户端请求</a></li>
<li><a href="#cun-chu-yin-qing">存储引擎</a></li>
</ul>
</li>
<li><a href="#qi-dong-xuan-xiang-he-xi-tong-bian-liang">启动选项和系统变量</a>
<ul>
<li><a href="#zai-ming-ling-xing-shang-shi-yong-xuan-xiang">在命令行上使用选项</a></li>
<li><a href="#pei-zhi-wen-jian-zhong-shi-yong-xuan-xiang">配置文件中使用选项</a>
<ul>
<li><a href="#windows-1">Windows</a></li>
<li><a href="#unix-1">UNIX</a></li>
</ul>
</li>
<li><a href="#xi-tong-bian-liang">系统变量</a>
<ul>
<li><a href="#cha-kan-xi-tong-bian-liang">查看系统变量</a></li>
<li><a href="#she-zhi-xi-tong-bian-liang">设置系统变量</a></li>
</ul>
</li>
<li><a href="#zhuang-tai-bian-liang">状态变量</a></li>
</ul>
</li>
<li><a href="#zi-fu-ji-he-bi-jiao-gui-ze">字符集和比较规则</a>
<ul>
<li><a href="#zi-fu-ji-de-zhuan-huan">字符集的转换</a></li>
</ul>
</li>
<li><a href="#innodb-ji-lu-cun">InnoDB记录存</a>
<ul>
<li><a href="#innodb-ye">InnoDB页</a></li>
<li><a href="#innodb-xing-ge-shi">InnoDB行格式</a>
<ul>
<li><a href="#compact-xing-ge-shi">Compact行格式</a></li>
<li><a href="#xing-shu-ju-yi-chu">行数据溢出</a></li>
<li><a href="#xing-yi-chu-de-lin-jie-dian">行溢出的临界点</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#innodb-shu-ju-ye">InnoDB数据页</a>
<ul>
<li><a href="#shu-ju-ye-jie-gou">数据页结构</a></li>
<li><a href="#ji-lu-zai-ye-zhong-de-cun-chu">记录在页中的存储</a>
<ul>
<li><a href="#ji-lu-tou-xin-xi">记录头信息</a></li>
</ul>
</li>
<li><a href="#page-directory">Page Directory</a></li>
<li><a href="#page-header">Page Header</a></li>
<li><a href="#file-header">File Header</a></li>
<li><a href="#file-trailer">File Trailer</a></li>
</ul>
</li>
<li><a href="#b-shu-suo-yin">B+树索引</a>
<ul>
<li><a href="#wu-suo-yin-cha-zhao">无索引查找</a>
<ul>
<li><a href="#zai-ye-nei-cha-zhao">在页内查找</a></li>
<li><a href="#zai-duo-ye-zhong-cha-zhao">在多页中查找</a></li>
</ul>
</li>
<li><a href="#suo-yin">索引</a>
<ul>
<li><a href="#mu-lu-xiang">目录项</a></li>
<li><a href="#yong-ye-cun-fang-mu-lu-xiang">用页存放目录项</a></li>
<li><a href="#ju-cu-suo-yin">聚簇索引</a></li>
<li><a href="#er-ji-suo-yin">二级索引</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#b-shu-suo-yin-de-shi-yong">B+树索引的使用</a>
<ul>
<li><a href="#he-li-shi-yong-suo-yin">合理使用索引</a>
<ul>
<li><a href="#quan-zhi-pi-pei">全值匹配</a></li>
<li><a href="#pi-pei-zuo-bian-de-lie">匹配左边的列</a></li>
<li><a href="#pi-pei-lie-qian-zhui">匹配列前缀</a></li>
</ul>
</li>
<li><a href="#hui-biao-de-dai-jie">回表的代价</a>
<ul>
<li><a href="#er-ji-suo-yin-hui-biao-or-quan-biao-sao-ma">二级索引 + 回表 or 全表扫码</a></li>
<li><a href="#fu-gai-suo-yin">覆盖索引</a></li>
</ul>
</li>
<li><a href="#he-li-di-jian-li-suo-yin">合理地建立索引</a></li>
</ul>
</li>
<li><a href="#mysql-de-shu-ju-mu-lu">MySQL的数据目录</a>
<ul>
<li><a href="#shu-ju-ku-he-wen-jian-xi-tong-de-guan-xi">数据库和文件系统的关系</a></li>
<li><a href="#shu-ju-mu-lu">数据目录</a>
<ul>
<li><a href="#shu-ju-mu-lu-he-an-zhuang-mu-lu-de-qu-bie">数据目录和安装目录的区别</a></li>
<li><a href="#cha-zhao-shu-ju-mu-lu">查找数据目录</a></li>
</ul>
</li>
<li><a href="#shu-ju-mu-lu-de-jie-gou">数据目录的结构</a>
<ul>
<li><a href="#shu-ju-ku-zai-wen-jian-xi-tong-zhong-de-biao-shi">数据库在文件系统中的表示</a></li>
<li><a href="#biao-zai-wen-jian-xi-tong-zhong-de-biao-shi">表在文件系统中的表示</a></li>
</ul>
</li>
<li><a href="#wen-jian-xi-tong-dui-shu-ju-ku-de-ying-xiang">文件系统对数据库的影响</a></li>
<li><a href="#mysql-xi-tong-shu-ju-ku-jian-jie">MySQL系统数据库简介</a></li>
</ul>
</li>
<li><a href="#innodb-biao-kong-jian">InnoDB表空间</a>
<ul>
<li><a href="#shu-ju-ye">数据页</a>
<ul>
<li><a href="#ye-lei-xing">页类型</a></li>
<li><a href="#ye-tong-yong-jie-gou">页通用结构</a></li>
</ul>
</li>
<li><a href="#du-li-biao-kong-jian-jie-gou">独立表空间结构</a>
<ul>
<li><a href="#qu-extent-de-gai-nian">区（extent）的概念</a></li>
<li><a href="#duan-segment-de-gai-nian">段（segment）的概念</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dan-biao-fang-wen-fang-fa">单表访问方法</a></li>
</ul>
<!-- tocstop -->
</div>
<p>本文为敝人的学习记录，感兴趣的请在掘金小册购买同名原著 😎</p>
<h2><span id="chong-xin-ren-shi-mysql">重新认识MySQL</span><a href="#chong-xin-ren-shi-mysql" class="header-anchor">#</a></h2>
<h3><span id="ke-hu-duan-fu-wu-qi">客户端 + 服务器</span><a href="#ke-hu-duan-fu-wu-qi" class="header-anchor">#</a></h3>
<p>MySQL服务器进程(也叫数据库实例)
MySQL客户端进程</p>
<p>进程：进程号(PID，由操作系统随机分配)、进程名称</p>
<p>MySQL服务器进程的默认名称为mysqld，
MySQL客户端进程的默认名称为mysql</p>
<h3><span id="qi-dong-fu-wu-qi-cheng-xu">启动服务器程序</span><a href="#qi-dong-fu-wu-qi-cheng-xu" class="header-anchor">#</a></h3>
<h4><span id="unix">UNIX</span><a href="#unix" class="header-anchor">#</a></h4>
<p>使用安装目录下(比如 <code>/usr/local/mysql/bin/</code>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld_safe</span><br></pre></td></tr></table></figure>
<p><code>mysqld_safe</code>是一个启动脚本的命令，调用了<code>mysqld</code>，并启动一个监控进程(重启，日志)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql.server start</span><br><span class="line">ysql.server stop</span><br></pre></td></tr></table></figure>
<p><code>mysql.server</code>是一个链接文件， 会调用<code>mysqld_safe</code></p>
<h4><span id="windows">Windows</span><a href="#windows" class="header-anchor">#</a></h4>
<p>使用安装目录下(比如 <code>D:\Program Files\mysql-5.7.26-winx64\bin\</code>) <code>mysqld.exe</code> 可执行文件</p>
<p>使用 Windows服务。把某个程序注册为Windows服务的格式：
&quot;可执行文件路径&quot; --install [-manual] [服务名称]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\Program Files\mysql-5.7.26-winx64\bin\mysqld --install [MySQL_Service]</span><br><span class="line">net start MySQL_Service</span><br><span class="line">net stop MySQL_Service</span><br></pre></td></tr></table></figure>
<h3><span id="qi-dong-ke-hu-duan-cheng-xu">启动客户端程序</span><a href="#qi-dong-ke-hu-duan-cheng-xu" class="header-anchor">#</a></h3>
<p>mysql -h主机名  -u用户名 -p密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -hlocalhost  -uroot -p123abc</span><br><span class="line">mysql -u root -p</span><br><span class="line">mysql --host=localhost  --user=root --password=123abc</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-c583b0a1eabe5ff6.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>退出客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">quit</span><br><span class="line">exit</span><br><span class="line">\q</span><br></pre></td></tr></table></figure>
<h3><span id="ke-hu-duan-yu-fu-wu-qi-de-tong-xin">客户端与服务器的通信</span><a href="#ke-hu-duan-yu-fu-wu-qi-de-tong-xin" class="header-anchor">#</a></h3>
<p>本质是两个进程间的通信</p>
<h4><span id="tcp-ip">TCP/IP</span><a href="#tcp-ip" class="header-anchor">#</a></h4>
<p>每台计算机都有一个唯一的IP地址
每个进程向操作系统申请一个端口号(0~65535)
通过IP地址 + 端口号来与某个进程通信
MySQL服务器进程的默认端口号为3306，自定义MySQL服务器进程的端口号如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld -P3307</span><br></pre></td></tr></table></figure>
<h4><span id="ming-ming-guan-dao-he-gong-xiang-nei-cun">命名管道和共享内存</span><a href="#ming-ming-guan-dao-he-gong-xiang-nei-cun" class="header-anchor">#</a></h4>
<p>Windows系统中的进程间通信方式</p>
<p>命名管道</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqld --enable-named-pipe</span><br><span class="line"></span><br><span class="line">mysql --pipe</span><br><span class="line">or</span><br><span class="line">mysql --protocol=pipe</span><br></pre></td></tr></table></figure>
<p>共享内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqld --shared-memory</span><br><span class="line"></span><br><span class="line">mysql --protocol=memory</span><br></pre></td></tr></table></figure>
<h4><span id="unix-yu-tao-jie-zi-wen-jian">UNIX域套接字文件</span><a href="#unix-yu-tao-jie-zi-wen-jian" class="header-anchor">#</a></h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --protocol=socket</span><br></pre></td></tr></table></figure>
<p>服务器程序默认监听的套接字文件路径为<code>/tmp/mysql.sock</code>，指定套接字文件路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --socket=/tmp/a.txt</span><br><span class="line">mysql -hlocalhost -uroot --socket=/tmp/a.txt -p</span><br></pre></td></tr></table></figure>
<h3><span id="fu-wu-qi-chu-li-ke-hu-duan-qing-qiu">服务器处理客户端请求</span><a href="#fu-wu-qi-chu-li-ke-hu-duan-qing-qiu" class="header-anchor">#</a></h3>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-a6bef812a91553aa.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3><span id="cun-chu-yin-qing">存储引擎</span><a href="#cun-chu-yin-qing" class="header-anchor">#</a></h3>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-b31ff09869340b51.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">
<code>XA</code>列代表是否支持分布式事务
<code>Savepoints</code>代表是否支持部分事务回滚</p>
<h2><span id="qi-dong-xuan-xiang-he-xi-tong-bian-liang">启动选项和系统变量</span><a href="#qi-dong-xuan-xiang-he-xi-tong-bian-liang" class="header-anchor">#</a></h2>
<h3><span id="zai-ming-ling-xing-shang-shi-yong-xuan-xiang">在命令行上使用选项</span><a href="#zai-ming-ling-xing-shang-shi-yong-xuan-xiang" class="header-anchor">#</a></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --skip-networking</span><br><span class="line">mysqld --default-storage-engine=MyISAM \\ 等号两边不能有空格</span><br></pre></td></tr></table></figure>
<p>使用<code>mysql --help</code>可以看到mysql程序支持的启动选项
使用<code>mysqld --verbose --help</code>查看mysqld支持的启动选项</p>
<h3><span id="pei-zhi-wen-jian-zhong-shi-yong-xuan-xiang">配置文件中使用选项</span><a href="#pei-zhi-wen-jian-zhong-shi-yong-xuan-xiang" class="header-anchor">#</a></h3>
<h4><span id="windows">Windows</span><a href="#windows" class="header-anchor">#</a></h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">%WINDIR%\my.ini</span><br><span class="line">%WINDIR%\my.cnf	</span><br><span class="line"></span><br><span class="line">C:\my.ini</span><br><span class="line">C:\my.cnf</span><br><span class="line"></span><br><span class="line">BASEDIR\my.ini  \\ MySQL安装路径</span><br><span class="line">BASEDIR\my.cnf	</span><br><span class="line"></span><br><span class="line">defaults-extra-file	命令行指定的额外配置文件路径，如</span><br><span class="line">mysqld --defaults-extra-file=C:\Users\chiangtao ho\my_extra_file.txt</span><br><span class="line"></span><br><span class="line">%APPDATA%\MySQL\.mylogin.cnf	登录路径选项（仅限客户端）</span><br></pre></td></tr></table></figure>
<h4><span id="unix">UNIX</span><a href="#unix" class="header-anchor">#</a></h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf	</span><br><span class="line">/etc/mysql/my.cnf	</span><br><span class="line">SYSCONFDIR/my.cnf	</span><br><span class="line">$MYSQL_HOME/my.cnf	特定于服务器的选项（仅限服务器）</span><br><span class="line"></span><br><span class="line">defaults-extra-file	</span><br><span class="line"></span><br><span class="line">~/.my.cnf	用户特定选项</span><br><span class="line"></span><br><span class="line">~/.mylogin.cnf	用户特定的登录路径选项（仅限客户端）</span><br></pre></td></tr></table></figure>
<h3><span id="xi-tong-bian-liang">系统变量</span><a href="#xi-tong-bian-liang" class="header-anchor">#</a></h3>
<h4><span id="cha-kan-xi-tong-bian-liang">查看系统变量</span><a href="#cha-kan-xi-tong-bian-liang" class="header-anchor">#</a></h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">like</span> <span class="string">'max_connections'</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'default%'</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>系统变量的单词之间必须使用下划线_连接</p>
</blockquote>
<h4><span id="she-zhi-xi-tong-bian-liang">设置系统变量</span><a href="#she-zhi-xi-tong-bian-liang" class="header-anchor">#</a></h4>
<p>变量的作用范围
<strong>GLOBAL</strong>：全局变量，影响服务器的整体操作
<strong>SESSION (LOCAL)</strong>：会话变量，影响某个客户端连接的操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> default_storage_engine = MyISAM;</span><br><span class="line"><span class="keyword">SET</span> @@GLOBAL.default_storage_engine = MyISAM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> default_storage_engine = MyISAM;</span><br><span class="line"><span class="keyword">SET</span> @@SESSION.default_storage_engine = MyISAM;</span><br><span class="line"><span class="keyword">SET</span> default_storage_engine = MyISAM; \\ 默认作用范围是LOCAL</span><br></pre></td></tr></table></figure>
<blockquote>
<p>那我们的SHOW VARIABLES语句默认查看的是SESSION作用范围的系统变量
并不是所有系统变量都具有GLOBAL和SESSION的作用范围</p>
</blockquote>
<h3><span id="zhuang-tai-bian-liang">状态变量</span><a href="#zhuang-tai-bian-liang" class="header-anchor">#</a></h3>
<p>与系统变量类似，状态变量也有GLOBAL和SESSION两个作用范围的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'thread%'</span>;</span><br></pre></td></tr></table></figure>
<h2><span id="zi-fu-ji-he-bi-jiao-gui-ze">字符集和比较规则</span><a href="#zi-fu-ji-he-bi-jiao-gui-ze" class="header-anchor">#</a></h2>
<p>查看字符集</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CHARSET</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-7c37618995aa0d2a.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><strong>Default collation</strong>表示字符集默认的比较规则
<strong>Maxlen</strong>代表该字符集表示一个字符最多需要几个字节</p>
<p>查看比较规则
<img src="https://upload-images.jianshu.io/upload_images/1863961-434c1321853a6064.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-28b9ac453cbdcce8.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<blockquote>
<p>MySQL中utf8是utf8mb3的别名，所以在MySQL中utf8就意味着使用1~3个字节来表示一个字符，如果大家有使用4字节编码一个字符的情况，比如存储一些emoji表情，使用utf8mb4</p>
</blockquote>
<p>MySQL有4个级别的字符集和比较规则，分别是：
服务器级别 <code>character_set_server</code>, <code>collation_server</code></p>
<p>数据库级别 <code>character_set_database</code>, <code>collation_database</code></p>
<p>表级别</p>
<p>列级别</p>
<blockquote>
<p>编码和解码使用的字符集不一致将导致乱码</p>
</blockquote>
<h3><span id="zi-fu-ji-de-zhuan-huan">字符集的转换</span><a href="#zi-fu-ji-de-zhuan-huan" class="header-anchor">#</a></h3>
<p><code>character_set_client</code> 服务器解码请求语句时使用的字符集</p>
<p><code>character_set_connection</code>	服务器处理请求时会把请求字符串从<code>character_set_client</code>转为<code>character_set_connection</code></p>
<p><code>character_set_results</code>	服务器向客户端返回数据时使用的字符集</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-d6053a1496be0af5.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<blockquote>
<p>通常把 <code>character_set_client</code> 、<code>character_set_connection</code>、<code>character_set_results</code> 这三个系统变量设置成和客户端使用的相同的字符集</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">NAMES</span> 字符集名;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> character_set_client = 字符集名;</span><br><span class="line"><span class="keyword">SET</span> character_set_connection = 字符集名;</span><br><span class="line"><span class="keyword">SET</span> character_set_results = 字符集名;</span><br></pre></td></tr></table></figure>
<h2><span id="innodb-ji-lu-cun">InnoDB记录存</span><a href="#innodb-ji-lu-cun" class="header-anchor">#</a></h2>
<h3><span id="innodb-ye">InnoDB页</span><a href="#innodb-ye" class="header-anchor">#</a></h3>
<p>InnoDB是一个将表中的数据存储到磁盘上的存储引擎。磁盘读写的速度比内存的读写速度差了几个数量级，因此设计InnoDB时将数据划分为若干个页并以页作为磁盘和内存之间交互的基本单位，页的大小一般为 16 KB。</p>
<h3><span id="innodb-xing-ge-shi">InnoDB行格式</span><a href="#innodb-xing-ge-shi" class="header-anchor">#</a></h3>
<p>4种行格式:</p>
<p>Compact</p>
<p>Redundant</p>
<p>Dynamic</p>
<p>Compressed</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名 ROW_FORMAT=行格式名称</span><br></pre></td></tr></table></figure>
<h4><span id="compact-xing-ge-shi">Compact行格式</span><a href="#compact-xing-ge-shi" class="header-anchor">#</a></h4>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-769f50ea36079f99.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>所有变长字段的真实数据占用的字节长度都被存放在<strong>变长字段长度列表</strong>
把值为NULL的列统一存储到<strong>NULL值列表</strong>中
<strong>记录头信息</strong>是由固定的5个字节组成</p>
<blockquote>
<p>MySQL会为每个记录默认的添加一些列（隐藏列），包括：<strong>row_id</strong>（DB_ROW_ID）、<strong>transaction_id</strong>（DB_TRX_ID）、<strong>roll_pointer</strong>（DB_ROLL_PTR）。</p>
</blockquote>
<h4><span id="xing-shu-ju-yi-chu">行数据溢出</span><a href="#xing-shu-ju-yi-chu" class="header-anchor">#</a></h4>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-a7e5ed104feb0ad1.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>对于MySQL的每条记录，除了BLOB或者TEXT类型的列之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535个字节。这个65535个字节除了列本身的数据之外，还包括一些其他的数据，即</p>
<ul>
<li>真实数据本身</li>
<li>真实数据占用字节的长度标识（&lt;= 2 bytes）</li>
<li>NULL值标识（&lt;= 1 byte），当列都有NOT NULL属性时为0</li>
</ul>
<p>因此，上图中设置变长类型<code>VARCHAR(M)</code>（M表示允许的字符数量）M=65535时导致了溢出。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-0e1da580a7f2aa45.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>真实数据：65533 = 65529(c1)+ 4(c2)</p>
<p>长度标识：2</p>
<p>NULL值标识：1</p>
<p>共65536 &gt; 65535溢出。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-f0eb4612f6ec51fd.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>更换字符集后溢出。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-58720a826df6d70e.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>VARCHAR(M)类型的列就最多可以存储65533个字节，而一个页的大小一般是16KB，也就是16384字节，因此在Compact和Reduntant行格式中，在本记录只会存储该列的前768个字节的数据和一个指向其他页的地址，然后把剩下的数据存放到其他页中；而在Dynamic和Compressed行格式中，记录中只存储其他页的地址。</p>
<h4><span id="xing-yi-chu-de-lin-jie-dian">行溢出的临界点</span><a href="#xing-yi-chu-de-lin-jie-dian" class="header-anchor">#</a></h4>
<p>MySQL中规定一个页中至少要存放两行记录</p>
<ul>
<li>每个页除了存放记录外，也需要存储一些额外的信息，这些额外信息加起来需要132个字节</li>
<li>每个记录的额外信息需要27字节
<ul>
<li>真实数据的长度标识 1B</li>
<li>NULL值标识 1B</li>
<li>记录头信息 5B</li>
<li>row_id 6B</li>
<li>transaction_id 6B</li>
<li>roll_pointer 7B</li>
</ul>
</li>
</ul>
<blockquote>
<p>不溢出的临界条件：132 + 2×(27 + n) &lt; 16384</p>
</blockquote>
<h2><span id="innodb-shu-ju-ye">InnoDB数据页</span><a href="#innodb-shu-ju-ye" class="header-anchor">#</a></h2>
<h3><span id="shu-ju-ye-jie-gou">数据页结构</span><a href="#shu-ju-ye-jie-gou" class="header-anchor">#</a></h3>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-7b48bacba1c08eed.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3><span id="ji-lu-zai-ye-zhong-de-cun-chu">记录在页中的存储</span><a href="#ji-lu-zai-ye-zhong-de-cun-chu" class="header-anchor">#</a></h3>
<p><img src="https://upload-images.jianshu.io/upload_images/1863961-c4157ce34c34235e.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h4><span id="ji-lu-tou-xin-xi">记录头信息</span><a href="#ji-lu-tou-xin-xi" class="header-anchor">#</a></h4>
<p>以 page_demo 表为例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> page_demo(</span><br><span class="line">    c1 <span class="built_in">INT</span>,</span><br><span class="line">    c2 <span class="built_in">INT</span>,</span><br><span class="line">    c3 <span class="built_in">VARCHAR</span>(<span class="number">10000</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (c1)</span><br><span class="line">) <span class="keyword">CHARSET</span>=<span class="keyword">ascii</span> ROW_FORMAT=<span class="keyword">Compact</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/1.PNG" alt=""></p>
<p>由于指定 c1 为主键，所以在行格式中就没有隐藏列 row_id。</p>
<p>插入数据4条记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> page_demo <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="number">100</span>, <span class="string">'aaaa'</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="number">200</span>, <span class="string">'bbbb'</span>),</span><br><span class="line">    (<span class="number">3</span>, <span class="number">300</span>, <span class="string">'cccc'</span>),</span><br><span class="line">    (<span class="number">4</span>, <span class="number">400</span>, <span class="string">'dddd'</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/images/2.PNG" alt=""></p>
<ul>
<li>
<p>delete_mask</p>
<p>标记当前记录是否被删除，值为0的时候代表记录没有被删除，1则被删除了；
所有被删的记录会组成一个<strong>垃圾链表</strong>，新记录插入到表时可以覆盖这些被删除的记录占用的存储空间。</p>
</li>
<li>
<p>n_owned</p>
<p>见<a href="#page-directory">Page Directory</a></p>
</li>
<li>
<p>heap_no</p>
<p>表示当前记录在本页中的位置，从上图中可以看出，插入的4条记录在本页中的位置分别是：2、3、4、5。最小记录和最大记录分别为0、1。</p>
<p><img src="/images/3.PNG" alt=""></p>
</li>
<li>
<p>record_type</p>
<p>记录类型，共4种：</p>
<p>0：普通记录</p>
<p>1：B+树非叶节点记录 （或目录项记录，见<a href="#mu-lu-xiang">目录项</a>）</p>
<p>2：最小记录</p>
<p>3：最大记录</p>
</li>
<li>
<p>min_rec_mask</p>
<p>代表B+树的每层非叶节点中的最小记录 （或者主键值最小的目录项记录的min_rec_mask值为1）</p>
</li>
<li>
<p>next_record</p>
<p>表示从当前记录的真实数据到下一条记录的真实数据的地址偏移量。例如第一条记录的next_record值为32，意味着从第一条记录的真实数据的地址处向后找32个字节便是下一条记录的真实数据。记录按照主键从小到大的顺序形成了一个单链表</p>
<p><img src="/images/4.PNG" alt=""></p>
</li>
</ul>
<p>如果删除第二条记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> page_demo <span class="keyword">WHERE</span> c1 = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/5.PNG" alt=""></p>
<p>删除第2条记录前后的主要变化：</p>
<ul>
<li>第2条记录的delete_mask值设置为1；</li>
<li>第2条记录的next_record值变为了0，意味着该记录没有下一条记录了；</li>
<li>第1条记录的next_record指向了第3条记录；</li>
<li>最大记录的n_owned值从5变成了4。</li>
</ul>
<h3><span id="page-directory">Page Directory</span><a href="#page-directory" class="header-anchor">#</a></h3>
<p>设计页目录是为了方便快速查找记录，就像书的目录那样，创建 page directory 的步骤：</p>
<ul>
<li>将所有正常的记录（包括最大和最小记录，不包括标记为已删除的记录）划分为几个组；</li>
<li>每个组内最大的那条记录的头信息的 n_owned 表示组内记录的数量；</li>
<li>将每个组的最大的那条记录的地址偏移量（也称槽，slot）集中起来存放，构成 Page Directory；</li>
</ul>
<p><img src="/images/6.PNG" alt=""></p>
<p>InnoDB规定最小记录所在的分组只能有 1 条记录，最大记录所在的分组的记录条数在 1~8 条之间，其它分组中记录的条数则在是 4~8 条之间。</p>
<p>利用页目录查找指定主键的记录的过程分为两步：</p>
<ul>
<li>通过二分法确定该记录所在的槽，并找到该槽中主键值最小的那条记录；</li>
<li>通过记录的 next_record 属性遍历组中的各个记录。</li>
</ul>
<h3><span id="page-header">Page Header</span><a href="#page-header" class="header-anchor">#</a></h3>
<p>存储数据的状态信息，比如本页中已经存储了多少条记录，第一条记录的地址是什么，页目录中存储了多少个槽等等。</p>
<h3><span id="file-header">File Header</span><a href="#file-header" class="header-anchor">#</a></h3>
<p>不同类型的页都会以File Header作为第一个组成部分，它记录了针对各种页都通用的一些信息。
索引页（数据页）通过 file header 构成双向链表</p>
<p><img src="/images/7.PNG" alt=""></p>
<h3><span id="file-trailer">File Trailer</span><a href="#file-trailer" class="header-anchor">#</a></h3>
<p>与file header一样对不同类型的页通用，主要用于校验页数据的完整性。</p>
<h2><span id="b-shu-suo-yin">B+树索引</span><a href="#b-shu-suo-yin" class="header-anchor">#</a></h2>
<h3><span id="wu-suo-yin-cha-zhao">无索引查找</span><a href="#wu-suo-yin-cha-zhao" class="header-anchor">#</a></h3>
<h4><span id="zai-ye-nei-cha-zhao">在页内查找</span><a href="#zai-ye-nei-cha-zhao" class="header-anchor">#</a></h4>
<ul>
<li>
<p>以主键查找
依据页目录（槽）采用二分查找定位分组，再遍历分组</p>
</li>
<li>
<p>以主键以外的列查找
遍历页内的记录链表</p>
</li>
</ul>
<h4><span id="zai-duo-ye-zhong-cha-zhao">在多页中查找</span><a href="#zai-duo-ye-zhong-cha-zhao" class="header-anchor">#</a></h4>
<ul>
<li>定位记录所在的页</li>
<li>页内查找</li>
</ul>
<h3><span id="suo-yin">索引</span><a href="#suo-yin" class="header-anchor">#</a></h3>
<p>建立索引是为了快速定位记录所在的数据页。</p>
<ul>
<li>对数据页进行排序。即让下一个数据页的记录的主键值大于上一个页的记录的主键值，因此在插入新的记录时涉及数据页间的记录的调整
<img src="/images/8.PNG" alt=""></li>
</ul>
<blockquote>
<p>对页进行排序后，全部记录的主键值就构成了一个递增的序列，从而可以利用二分法实现快速查找。</p>
</blockquote>
<ul>
<li>对每个页设置目录项</li>
</ul>
<h4><span id="mu-lu-xiang">目录项</span><a href="#mu-lu-xiang" class="header-anchor">#</a></h4>
<p>目录项包括</p>
<ul>
<li>数据页中的记录的最小主键值，用key来表示；</li>
<li>页号，用page_no表示。</li>
</ul>
<p><img src="/images/9.PNG" alt=""></p>
<h4><span id="yong-ye-cun-fang-mu-lu-xiang">用页存放目录项</span><a href="#yong-ye-cun-fang-mu-lu-xiang" class="header-anchor">#</a></h4>
<p><img src="/images/10.PNG" alt="">
<img src="/images/11.PNG" alt="">
<img src="/images/12.PNG" alt=""></p>
<p>用户记录都存放在B+树的叶节点上，而目录项都存放在非页节点上。</p>
<h4><span id="ju-cu-suo-yin">聚簇索引</span><a href="#ju-cu-suo-yin" class="header-anchor">#</a></h4>
<p>特性包括：</p>
<ol>
<li>依据记录的主键值排序
<ul>
<li>页内的记录是按照主键的大小顺序排成一个单向链表</li>
<li>数据页根据主键大小顺序排成一个双向链表</li>
<li>存放目录项记录的页根据主键大小分为不同的层次</li>
</ul>
</li>
<li>B+树的叶节点存储的是完整的记录，即记录的所有列的值（包括隐藏列）</li>
</ol>
<h4><span id="er-ji-suo-yin">二级索引</span><a href="#er-ji-suo-yin" class="header-anchor">#</a></h4>
<p>依据记录的其它列（比如c1）的值排序形成的B+树。将聚簇索引的主键值换为c1的值，此外，叶节点存储的不是完整的记录而只有主键和c1。</p>
<blockquote>
<p>通过二级索引来查找完整记录：通过二级索引找到主键值之后再通过聚簇索引查找完整记录。</p>
</blockquote>
<h2><span id="b-shu-suo-yin-de-shi-yong">B+树索引的使用</span><a href="#b-shu-suo-yin-de-shi-yong" class="header-anchor">#</a></h2>
<h3><span id="he-li-shi-yong-suo-yin">合理使用索引</span><a href="#he-li-shi-yong-suo-yin" class="header-anchor">#</a></h3>
<p>考虑表 person_info</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> person_info(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> auto_increment,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    birthday <span class="built_in">DATE</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone <span class="built_in">CHAR</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    country <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>),</span><br><span class="line">    <span class="keyword">KEY</span> idx_name_birthday_phone (<span class="keyword">name</span>, birthday, phone)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>idx_name_birthday_phone 为二级索引
<img src="/images/13.PNG" alt=""></p>
<h4><span id="quan-zhi-pi-pei">全值匹配</span><a href="#quan-zhi-pi-pei" class="header-anchor">#</a></h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'Ashburn'</span> <span class="keyword">AND</span> birthday = <span class="string">'1990-09-27'</span> <span class="keyword">AND</span> phone = <span class="string">'15123983239'</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>由于查询优化器的存在，调换name、birthday、phone这几个搜索列的顺序<strong>不影响</strong>查询的执行过程。</p>
</blockquote>
<h4><span id="pi-pei-zuo-bian-de-lie">匹配左边的列</span><a href="#pi-pei-zuo-bian-de-lie" class="header-anchor">#</a></h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'Ashburn'</span>;</span><br></pre></td></tr></table></figure>
<p>可以使用索引idx_name_birthday_phone，而</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> birthday = <span class="string">'1990-09-27'</span>;</span><br></pre></td></tr></table></figure>
<p>不能使用索引idx_name_birthday_phone。</p>
<h4><span id="pi-pei-lie-qian-zhui">匹配列前缀</span><a href="#pi-pei-lie-qian-zhui" class="header-anchor">#</a></h4>
<p>比如查询名字以 As 开头的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'As%'</span>;</span><br></pre></td></tr></table></figure>
<h3><span id="hui-biao-de-dai-jie">回表的代价</span><a href="#hui-biao-de-dai-jie" class="header-anchor">#</a></h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">'Asa'</span> <span class="keyword">AND</span> <span class="keyword">name</span> &lt; <span class="string">'Barlow'</span>;</span><br></pre></td></tr></table></figure>
<p>二级索引搜索到的结果（即值在Asa～Barlow之间的记录）在磁盘中的存储是相连的，集中分布在一个或几个数据页中，因此可以很快从磁盘中读出，这种读取方式可以称为顺序I/O。而回表是根据不连续的id值到聚簇索引中读出完整的用户记录（可能分布在不同的数据页中），这种读取方式可以称为随机I/O。一般情况下，顺序I/O比随机I/O的性能高很多。</p>
<h4><span id="er-ji-suo-yin-hui-biao-or-quan-biao-sao-ma">二级索引 + 回表 or 全表扫码</span><a href="#er-ji-suo-yin-hui-biao-or-quan-biao-sao-ma" class="header-anchor">#</a></h4>
<p>需要回表的记录越多，使用二级索引的性能就越低，甚至不如使用聚簇索引全表扫码；</p>
<p>使用<code>LIMIT</code>限制回表次数，使优化器倾向于使用二级索引 + 回表的方式执行查询。</p>
<h4><span id="fu-gai-suo-yin">覆盖索引</span><a href="#fu-gai-suo-yin" class="header-anchor">#</a></h4>
<p>如果需要查询的列包含在二级索引中，就可以避免回表查询，这种只需要用到索引的查询方式称为索引覆盖。例如对于索引idx_name_birthday_phone</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, birthday, phone <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">'Asa'</span> <span class="keyword">AND</span> <span class="keyword">name</span> &lt; <span class="string">'Barlow'</span></span><br></pre></td></tr></table></figure>
<h3><span id="he-li-di-jian-li-suo-yin">合理地建立索引</span><a href="#he-li-di-jian-li-suo-yin" class="header-anchor">#</a></h3>
<ul>
<li>
<p>只给搜索、排序、分组的列创建索引</p>
<p>即只给出现在 WHERE、ORDER BY、GROUP BY 子句中的列创建索引；</p>
</li>
<li>
<p>列的方差越大越适合建立索引</p>
<p>列的数据越分散，越适合索引查询。举个极端的例子，数据都相同的列，对这样的列建立索引毫无意义；</p>
</li>
<li>
<p>列的数据类型越小越适合建立索引</p>
<p>比较数据大小更快，占用的存储空间更小；</p>
</li>
<li>
<p>索引字符串的前缀</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> person_info(</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    birthday <span class="built_in">DATE</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone <span class="built_in">CHAR</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    country <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">KEY</span> idx_name_birthday_phone (<span class="keyword">name</span>(<span class="number">10</span>), birthday, phone)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>其中 name(10) 表示在建立的B+树索引中只保留记录的前10个字符的编码，但是该索引不支持 name 排序</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span> <span class="keyword">LIMIT</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>让索引列在比较表达式中单独出现</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WHERE my_col * 2 &lt; 4</span><br><span class="line">WHERE my_col &lt; 4/2</span><br></pre></td></tr></table></figure>
<p>如果列是以某个表达式或者函数调用形式出现是用不到索引的，比如上面的<code>my_col * 2</code>；</p>
</li>
<li>
<p>开启主键AUTO_INCREMENT属性</p>
<p>可减少页分裂和记录移位的次数。</p>
</li>
</ul>
<h2><span id="mysql-de-shu-ju-mu-lu">MySQL的数据目录</span><a href="#mysql-de-shu-ju-mu-lu" class="header-anchor">#</a></h2>
<h3><span id="shu-ju-ku-he-wen-jian-xi-tong-de-guan-xi">数据库和文件系统的关系</span><a href="#shu-ju-ku-he-wen-jian-xi-tong-de-guan-xi" class="header-anchor">#</a></h3>
<p>InnoDB、MyISAM等存储引擎都是把表存储在磁盘上。操作系统通过文件系统管理磁盘。</p>
<p>InnoDB、MyISAM等存储引擎 $ \Leftrightarrow $ 文件系统 $ \Leftrightarrow $ 磁盘</p>
<h3><span id="shu-ju-mu-lu">数据目录</span><a href="#shu-ju-mu-lu" class="header-anchor">#</a></h3>
<h4><span id="shu-ju-mu-lu-he-an-zhuang-mu-lu-de-qu-bie">数据目录和安装目录的区别</span><a href="#shu-ju-mu-lu-he-an-zhuang-mu-lu-de-qu-bie" class="header-anchor">#</a></h4>
<p>数据目录是用来存储MySQL在运行过程中产生的数据，要与MySQL的安装目录区别开来。</p>
<h4><span id="cha-zhao-shu-ju-mu-lu">查找数据目录</span><a href="#cha-zhao-shu-ju-mu-lu" class="header-anchor">#</a></h4>
<p><img src="/images/14.PNG" alt=""></p>
<h3><span id="shu-ju-mu-lu-de-jie-gou">数据目录的结构</span><a href="#shu-ju-mu-lu-de-jie-gou" class="header-anchor">#</a></h3>
<h4><span id="shu-ju-ku-zai-wen-jian-xi-tong-zhong-de-biao-shi">数据库在文件系统中的表示</span><a href="#shu-ju-ku-zai-wen-jian-xi-tong-zhong-de-biao-shi" class="header-anchor">#</a></h4>
<p>每新建一个数据库，MySQL执行了：</p>
<ul>
<li>在数据目录下创建一个和数据库名同名的子目录；</li>
<li>并在该子目录下创建一个db.opt文件，这个文件中包含了该数据库的各种属性，比方说该数据库的字符集和比较规则等。</li>
</ul>
<p>查看数据库
<img src="/images/15.PNG" alt="">
查看数据目录
<img src="/images/16.PNG" alt=""></p>
<p>除了information_schema这个系统数据库外，其他的数据库在数据目录下都有对应的子目录。</p>
<h4><span id="biao-zai-wen-jian-xi-tong-zhong-de-biao-shi">表在文件系统中的表示</span><a href="#biao-zai-wen-jian-xi-tong-zhong-de-biao-shi" class="header-anchor">#</a></h4>
<p>每个表包含两部分信息：</p>
<ul>
<li>
<p>表结构的定义</p>
<p>用<code>表名.frm</code>文件来描述表结构</p>
</li>
<li>
<p>表中的数据</p>
<p>InnoDB: 数据存在独立表空间(file-per-table tablespace)中，即 <code>test.ibd</code> 文件</p>
<p>MyISAM: <code>表名.MYD</code>表示表的数据文件、<code>表名.MYI</code>表示表的索引文件</p>
</li>
</ul>
<h3><span id="wen-jian-xi-tong-dui-shu-ju-ku-de-ying-xiang">文件系统对数据库的影响</span><a href="#wen-jian-xi-tong-dui-shu-ju-ku-de-ying-xiang" class="header-anchor">#</a></h3>
<ul>
<li>
<p>数据库名和表名不得超过文件系统所允许的最大长度</p>
</li>
<li>
<p>特殊字符</p>
<p>MySQL会把数据库名和表名中除<strong>数字</strong>和<strong>拉丁字母</strong>外的所有字符在文件名里都映射成 @+编码值的形式，如<code>test?.frm</code> $ \rightarrow $ <code>test@003f.frm</code></p>
</li>
<li>
<p>文件大小受文件系统限制</p>
</li>
</ul>
<h3><span id="mysql-xi-tong-shu-ju-ku-jian-jie">MySQL系统数据库简介</span><a href="#mysql-xi-tong-shu-ju-ku-jian-jie" class="header-anchor">#</a></h3>
<ul>
<li>
<p>mysql</p>
<p>存储了MySQL的账户和权限信息，一些存储过程、事件的定义信息，一些运行过程中产生的日志信息、以及时区信息等</p>
</li>
<li>
<p>information_schema</p>
<p>这个数据库保存着MySQL服务器维护的所有其他数据库的信息，比如表、视图、触发器、列、索引等</p>
</li>
<li>
<p>performance_schema</p>
<p>这个数据库里主要保存MySQL服务器运行过程中的一些状态信息，包括统计最近执行的语句，执行时间，内存使用情况等</p>
</li>
<li>
<p>sys</p>
<p>这个数据库主要是通过视图的形式把information_schema和performance_schema结合起来</p>
</li>
</ul>
<h2><span id="innodb-biao-kong-jian">InnoDB表空间</span><a href="#innodb-biao-kong-jian" class="header-anchor">#</a></h2>
<p>表空间对应着文件系统中一个或多个实际文件（独立表空间对应一个<code>表名.ibd</code>文件）。可以把表空间想象成一本书，当想为某个表插入一条记录的时候，就在书中对应的页来把数据写进去。</p>
<h3><span id="shu-ju-ye">数据页</span><a href="#shu-ju-ye" class="header-anchor">#</a></h3>
<h4><span id="ye-lei-xing">页类型</span><a href="#ye-lei-xing" class="header-anchor">#</a></h4>
<p><img src="/images/198.png" alt=""></p>
<h4><span id="ye-tong-yong-jie-gou">页通用结构</span><a href="#ye-tong-yong-jie-gou" class="header-anchor">#</a></h4>
<p><img src="/images/199.jpg" alt=""></p>
<p>File Header : 记录数据页的一些通用信息
<img src="/images/200.png" alt=""></p>
<p>File Trailer：校验数据页，保证从内存到磁盘的数据的一致性</p>
<h3><span id="du-li-biao-kong-jian-jie-gou">独立表空间结构</span><a href="#du-li-biao-kong-jian-jie-gou" class="header-anchor">#</a></h3>
<h4><span id="qu-extent-de-gai-nian">区（extent）的概念</span><a href="#qu-extent-de-gai-nian" class="header-anchor">#</a></h4>
<p>数据页16KB</p>
<p>物理上连续的64个页就是一个区1MB</p>
<p>每256个区被划分成一组，每个组的最开始的几个页面类型是固定的</p>
<p>系统表空间或独立表空间由若干个区组成</p>
<p><img src="/images/201.jpg" alt=""></p>
<p><img src="/images/202.jpg" alt=""></p>
<p>为什么引入区的设计？</p>
<blockquote>
<p>区是连续的存储空间，这样可以减少随机I/O， 增加顺序I/O</p>
</blockquote>
<h4><span id="duan-segment-de-gai-nian">段（segment）的概念</span><a href="#duan-segment-de-gai-nian" class="header-anchor">#</a></h4>
<p>所以设计InnoDB的大叔们对B+树的叶子节点和非叶子节点进行了区别对待，也就是说叶子节点有自己独有的区，非叶子节点也有自己独有的区。存放叶子节点的区的集合就算是一个段（segment），存放非叶子节点的区的集合也算是一个段。也就是说一个索引会生成2个段，一个叶子节点段，一个非叶子节点段。</p>
<h2><span id="dan-biao-fang-wen-fang-fa">单表访问方法</span><a href="#dan-biao-fang-wen-fang-fa" class="header-anchor">#</a></h2>

  </section>

</article>

<section class="read-more">
     

        
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h3 class="post-list__post-title post-title"><a href="/2019/11/25/2019-11-25/" title="数学通识50讲">数学通识50讲</a></h3>
                <p class="excerpt">
                
                




发刊词：数学该怎么学？


模块一 ｜ 数学的线索

01 ｜ 导论：数学通识课的体系和学习攻略
02 ｜ 勾股定理：为什么在西方叫毕达哥拉斯定理
03 ｜ 数学的预见性：如何用推理走出认知盲区
04 ｜ 数学思维：数学家如何从逻辑出发想问题
05 ｜ 数学边界：从毕达哥拉斯定理到费马大定
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2019-11-24T16:00:00.000Z" class="post-list__meta--date date">2019-11-25</time> &#8226; <span class="post-list__meta--tags tags">
  <a class="tag-link" href="/tags/吴军/">吴军</a>, <a class="tag-link" href="/tags/数学/">数学</a>, <a class="tag-link" href="/tags/电子书/">电子书</a>
</span><a class="btn-border-small" href="/2019/11/25/2019-11-25/">阅读全文</a></div>

            </div>
        

        
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h3 class="post-list__post-title post-title"><a href="/2019/09/05/2019-9-5/" title="SQL Notes">SQL Notes</a></h3>
                <p class="excerpt">
                
                



联表查询
字符替换
正则查询
导入SQL文件
排序
分组
时间转换
线程
常用命令



联表查询#
12345678SELECT library.id, library.name, r.reader_sum, b.book_sum FROM library INNER JOIN( SELE
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2019-09-04T16:00:00.000Z" class="post-list__meta--date date">2019-09-05</time> &#8226; <span class="post-list__meta--tags tags">
  <a class="tag-link" href="/tags/SQL/">SQL</a>
</span><a class="btn-border-small" href="/2019/09/05/2019-9-5/">阅读全文</a></div>

            </div>
        

   


</section>


  


            <footer class="footer">
    <span class="footer__copyright">
        2021 &copy; Jiang-Tao He - Powered by <a href="https://hexo.io">Hexo</a> with <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> theme originated from <a href="https://github.com/onevcat/vno" target="_blank">onevcat</a>. Hosted by Netlify.

    </span>
    <span class="footer__copyright">
            
         </span>


  
         <script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    }); 
    
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
 
</footer>


<div id="totop" style="position:fixed;bottom:150px;right:20px;cursor: pointer;">
<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js"></script>


        </div>
    </div>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-119463453-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?cbff5c9c1c024f714d2c51527df12893";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":140,"height":280,"hOffset":-28,"vOffset":-63},"mobile":{"show":true,"motion":true},"log":false,"tagMode":false});</script></body>
</html>
